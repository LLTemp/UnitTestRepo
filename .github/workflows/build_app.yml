name: SIC Example App

on:
  push:
    branches: [ master ]
    paths:
      - 'UnitTestWithPodAPP/**'
  pull_request:
    branches: [ master ]
    paths:
      - 'UnitTestWithPodAPP/**'

defaults:
  run:
    working-directory: ./UnitTestWithPodAPP

jobs:
  build:
    env:
      commitmsg: ${{ github.event.head_commit.message }}
    runs-on: macos-10.15


    steps:
    - uses: actions/checkout@v2

    - name: Echo message
      run: echo Commit MSG = ${{ env.commitmsg }}

 #Actions to run example application
    - name: Pod install
      run: pod install

    - name: Run unit tests
      run: xcodebuild test -workspace ./UnitTestWithPodApp.xcworkspace -scheme UnitTestWithPodAPPTests ONLY_ACTIVE_ARCH=YES CODE_SIGN_REQUIRE=NO -destination "platform=iOS Simulator,OS=14.2,name=iPhone 8"

    - name: Archive test report
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: Coverage
        path: /Users/runner/Library/Developer/Xcode/DerivedData/UnitTestWithPodAPP-aixaeyjiavyyshfgxjwdsrcmncun/Logs/Test/*.xcresult

    - name: Create keychain
      if: ${{ contains($commitmsg, 'upload_source') == 'true' && github.event_name == 'push'}}
      env:
        P12_SECRET: ${{ secrets.P12_SECRET }}
      run: ./scripts/add-key.sh

    - name: Build archive
      if: ${{ github.event_name == 'push' }}
      run: |
        xcodebuild -workspace ./UnitTestWithPodAPP.xcworkspace -scheme UnitTestWithPodAPP -sdk iphoneos -configuration Release archive -archivePath ./build/UnitTestWithPodAPP.xcarchive
        xcodebuild -exportArchive -archivePath ./build/UnitTestWithPodAPP.xcarchive -exportOptionsPlist ./scripts/exportOptions.plist -exportPath ./build

    - name: Archive Archive
      if: ${{ github.event_name == 'push' }}
      uses: actions/upload-artifact@v2
      with:
        name: UnitTestWithPodAPP.xcarchive
        path: UnitTestWithPodAPP/build/UnitTestWithPodAPP.xcarchive

    - name: Install firebase tools
      if: ${{ github.event_name == 'push' }}
      run: npm install -g firebase-tools

    - name: Upload to Firebase
      if: ${{ github.event_name == 'push' }}
      env:
        FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        GROUPS_LIST: ${{ secrets.GROUPS_LIST }}
      run: ./scripts/firebase_upload.sh

#    - name: Upload source code to other repo
#      if: ${{ github.event_name == 'push' }}
#      env:
#        FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
#        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
#        GROUPS_LIST: ${{ secrets.GROUPS_LIST }}
#      run: ./scripts/firebase_upload.sh
